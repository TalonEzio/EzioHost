@page "/settings/cloudflare-storage"
@rendermode InteractiveServer
@attribute [Authorize]

<PageTitle>Cài đặt Cloudflare R2 Storage - EzioHost</PageTitle>

<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="flex items-center gap-3 text-3xl font-bold text-gray-900 mb-2">
            <i class="bi bi-cloud-upload text-blue-600 text-2xl"></i>
            Cài đặt Cloudflare R2 Storage
        </h1>
        <p class="text-gray-600">Cấu hình upload video lên Cloudflare R2 sau khi xử lý</p>
    </div>

    @if (IsLoading)
    {
        <div class="flex flex-col items-center justify-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-600">Đang tải cài đặt...</p>
        </div>
    }
    else
    {
        <!-- Settings Form -->
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm">
            <!-- Enable/Disable Section -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center gap-3 mb-2">
                    <i class="bi bi-toggle-on text-blue-600 text-xl"></i>
                    <h2 class="text-xl font-semibold text-gray-900">Bật/Tắt Upload lên Cloudflare R2</h2>
                </div>
                <p class="text-sm text-gray-600 mb-4">Kích hoạt hoặc vô hiệu hóa tính năng upload video lên Cloudflare R2 sau khi xử lý</p>

                <div class="space-y-3">
                    <label class="flex items-center justify-between p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="bi bi-cloud-upload text-gray-700"></i>
                            <div>
                                <span class="font-medium text-gray-900 block">Bật Upload lên Cloudflare R2</span>
                                <span class="text-sm text-gray-600">Khi bật, video sẽ được upload lên Cloudflare R2 sau khi xử lý xong</span>
                            </div>
                        </div>
                        <div class="relative inline-block w-12 h-6">
                            <input type="checkbox" 
                                   checked="@Settings.IsEnabled" 
                                   @onchange="@(e => Settings.IsEnabled = (bool)(e.Value ?? false))"
                                   class="sr-only peer"/>
                            <div class="w-12 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </div>
                    </label>
                    <div class="ml-11 p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-700">
                            <strong>Khi bật:</strong> Video stream sẽ được upload lên Cloudflare R2 ngay sau khi xử lý xong. URL manifest sẽ trỏ đến CDN của Cloudflare.
                        </p>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Khi tắt:</strong> Video chỉ được lưu local. URL manifest sẽ trỏ đến static file server của bạn.
                        </p>
                        <p class="text-sm text-amber-700 mt-2">
                            <i class="bi bi-info-circle"></i> <strong>Lưu ý:</strong> Cài đặt này chỉ áp dụng cho các video được xử lý sau khi bạn thay đổi setting. Video đã xử lý trước đó sẽ giữ nguyên cách lưu trữ ban đầu.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-6 flex justify-end gap-3">
                <button class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        @onclick="ResetToDefaults" 
                        disabled="@(IsSaving || IsLoading)">
                    <i class="bi bi-arrow-counterclockwise mr-2"></i>
                    Đặt lại mặc định
                </button>
                <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        @onclick="SaveSettings" 
                        disabled="@(IsSaving || IsLoading)">
                    @if (IsSaving)
                    {
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        <span>Đang lưu...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle"></i>
                        <span>Lưu cài đặt</span>
                    }
                </button>
            </div>

            @if (!string.IsNullOrEmpty(SuccessMessage))
            {
                <div class="mx-6 mb-6 p-4 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2 text-green-700">
                    <i class="bi bi-check-circle text-green-600"></i>
                    <span>@SuccessMessage</span>
                </div>
            }

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="mx-6 mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2 text-red-700">
                    <i class="bi bi-exclamation-circle text-red-600"></i>
                    <span>@ErrorMessage</span>
                </div>
            }
        </div>
    }
</div>
