@page "/video-upload"
@rendermode InteractiveServer

@attribute [Authorize]
@using EzioHost.Components.SeekableInputFile
@implements IAsyncDisposable

<PageTitle>Upload Video - EzioHost</PageTitle>

@if (RendererInfo.IsInteractive)
{
	<div class="container py-4">
		<!-- Header -->
		<div class="row mb-4">
			<div class="col-12">
				<h1 class="h2 fw-bold mb-2">
					<i class="bi bi-cloud-upload me-2"></i>
					Upload Video
				</h1>
				<p class="text-muted">Tải lên video của bạn</p>
			</div>
		</div>

		<div class="row">
			<!-- Upload Section -->
			<div class="col-lg-8">
				<div class="card border-0 shadow-sm">
					<div class="card-body p-4">
						<!-- File Selection -->
						<div class="upload-zone @(IsDragOver ? "drag-over" : "")"
						     @ref="_dropZone"
						     @ondragover:preventDefault="true"
						     @ondragenter:preventDefault="true"
						     @ondragleave:preventDefault="true"
						     @ondrop:preventDefault="true">
							<SeekableInputFile OnChanged="OnFilesChanged"
							                   class="d-none" id="videoFileInput" accept="video/*" multiple/>

							@if (SelectedFiles.Any())
							{
								<div class="uploaded-files mt-3">
									<h5 class="mb-3">Files đã chọn: </h5>
									@foreach (var file in SelectedFiles)
									{
										<div class="file-item d-flex align-items-center justify-content-between p-3 bg-light rounded mb-2"
										     @onclick="() => SelectFile(file)"
										     style="cursor: pointer;">
											<div class="d-flex align-items-center flex-grow-1">
												<i class="bi bi-file-earmark-play text-primary me-3" style="font-size: 1.5rem;"></i>
												<div class="flex-grow-1">
													<div class="fw-bold">@file.Name</div>
													<small class="text-muted">@FormatFileSize(file.Size)</small>
													@if (!string.IsNullOrEmpty(file.Checksum))
													{
														<div>
															<small class="text-muted">Checksum: @file.Checksum.Substring(0, Math.Min(16, file.Checksum.Length))...</small>
														</div>
													}
												</div>
											</div>
											<button class="btn btn-outline-danger btn-sm"
											        @onclick="() => RemoveFile(file)"
											        @onclick:stopPropagation="true"
											        disabled="@IsUploading">
												<i class="bi bi-x"></i>
											</button>
										</div>
									}
								</div>
							}
							else
							{
								<div class="upload-placeholder text-center py-5">
									<i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
									<h4 class="mb-3">Kéo thả video vào đây</h4>
									<p class="text-muted mb-4">Hoặc click để chọn file</p>
									<button class="btn btn-primary btn-lg" @onclick="TriggerFileInput" @onclick:preventDefault="true" type="button">
										<i class="bi bi-folder2-open me-2"></i>Chọn Video
									</button>
								</div>
							}
						</div>

						<!-- Upload Progress -->
						@if (IsUploading)
						{
							<div class="mt-4">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-bold">Đang upload...</span>
									<span class="text-muted">@UploadProgress%</span>
								</div>
								<div class="progress">
									<div class="progress-bar progress-bar-striped progress-bar-animated"
									     role="progressbar"
									     style="width: @UploadProgress%">
									</div>
								</div>
								<div class="mt-2">
									<small class="text-muted">@CurrentUploadFileName</small>
								</div>
							</div>
						}
					</div>
				</div>

				<!-- Video Settings -->
				@if (SelectedFiles.Any())
				{
					<div class="card border-0 shadow-sm mt-4">
						<div class="card-header bg-light">
							<h5 class="mb-0">
								<i class="bi bi-gear me-2"></i>Cài đặt Video
							</h5>
						</div>
						<div class="card-body">
							<div class="row g-3">
								<div class="col-12">
									<label class="form-label">Tiêu đề</label>
									<input type="text" class="form-control" @bind="VideoTitle" placeholder="Nhập tiêu đề video hoặc click vào file để tự động điền" disabled="@IsUploading"/>
								</div>
								<div class="col-12">
									<label class="form-label">Mô tả</label>
									<textarea class="form-control" rows="3" @bind="VideoDescription" placeholder="Mô tả video (tùy chọn)" disabled="@IsUploading"></textarea>
								</div>
							</div>
						</div>
					</div>
				}
			</div>

			<!-- Sidebar -->
			<div class="col-lg-4">
				<!-- Upload Guidelines -->
				<div class="card border-0 shadow-sm mb-4">
					<div class="card-header bg-primary text-white">
						<h6 class="mb-0">
							<i class="bi bi-info-circle me-2"></i>Hướng dẫn Upload
						</h6>
					</div>
					<div class="card-body">
						<ul class="list-unstyled mb-0">
							<li class="mb-2">
								<i class="bi bi-check-circle text-success me-2"></i>
								<strong>Định dạng hỗ trợ:</strong> MP4, AVI, MOV, MKV
							</li>
							<li class="mb-2">
								<i class="bi bi-check-circle text-success me-2"></i>
								<strong>Kích thước tối đa:</strong> 2GB mỗi file
							</li>
							<li class="mb-2">
								<i class="bi bi-check-circle text-success me-2"></i>
								<strong>Chất lượng:</strong> Không quá 4K
							</li>
						</ul>
					</div>
				</div>

				<!-- Upload Actions -->
				@if (SelectedFiles.Any())
				{
					<div class="card border-0 shadow-sm">
						<div class="card-body">
							<h6 class="mb-3">Hành động</h6>
							<div class="d-grid gap-2">
								<button class="btn btn-primary" @onclick="StartUpload" disabled="@IsUploading">
									@if (IsUploading)
									{
										<span class="spinner-border spinner-border-sm me-2"></span>
										<span>Đang upload...</span>
									}
									else
									{
										<i class="bi bi-cloud-upload me-2"></i>
										<span>Bắt đầu Upload</span>
									}
								</button>
								<button class="btn btn-outline-secondary" @onclick="ClearFiles" disabled="@IsUploading">
									<i class="bi bi-x-circle me-2"></i>Xóa tất cả
								</button>
							</div>
						</div>
					</div>
				}
			</div>
		</div>
	</div>
}
else
{
	<div class="text-center py-5">
		<div class="spinner-border text-primary" role="status">
			<span class="visually-hidden">Loading...</span>
		</div>
		<p class="text-muted mt-3">Loading page...</p>
	</div>
}