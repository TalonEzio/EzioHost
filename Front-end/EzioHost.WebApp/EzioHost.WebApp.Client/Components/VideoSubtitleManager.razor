@using EzioHost.WebApp.Client.Services
@using EzioHost.Shared.Helpers
@using Refit
<div class="space-y-4">
    <div class="flex justify-between items-center">
        <h6 class="text-sm font-semibold text-gray-900">Quản lý Subtitle</h6>
    </div>

    <!-- Subtitle List -->
    <div class="space-y-2 max-h-48 overflow-y-auto">
        @if (Subtitles != null && Subtitles.Any())
        {
            @foreach (var subtitle in Subtitles)
            {
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900">@subtitle.Language</span>
                        <span class="text-xs text-gray-500 ml-2">@subtitle.FileName</span>
                    </div>
                    <button type="button"
                            class="px-2 py-1 text-red-600 hover:bg-red-50 rounded transition-colors text-sm"
                            @onclick="() => DeleteSubtitle(subtitle.Id)"
                            disabled="@IsDeleting">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            }
        }
        else
        {
            <p class="text-sm text-gray-500 text-center py-2">Chưa có subtitle nào</p>
        }
    </div>

    <!-- Audio Transcribing Button -->
    @if (CanPlay && (Subtitles == null || !Subtitles.Any()))
    {
        <div class="border-t border-gray-200 pt-4">
            <button type="button"
                    class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                    @onclick="ShowTranscribeModal">
                <i class="bi bi-mic mr-1"></i>Audio Transcribing
            </button>
        </div>
    }

    <!-- Upload Form -->
    <div class="border-t border-gray-200 pt-4">
        <h6 class="text-sm font-semibold text-gray-900 mb-3">Thêm Subtitle mới</h6>
        <EditForm Model="@UploadModel" OnValidSubmit="HandleUpload">
            <DataAnnotationsValidator/>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngôn ngữ</label>
                    <InputText @bind-Value="UploadModel.Language"
                               class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               placeholder="Ví dụ: Vietnamese, English"/>
                    <ValidationMessage For="@(() => UploadModel.Language)"/>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">File Subtitle (.vtt)</label>
                    <InputFile OnChange="HandleFileSelected"
                               accept=".vtt"
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"/>
                    <ValidationMessage For="@(() => UploadModel.File)"/>
                    @if (SelectedFileName != null)
                    {
                        <p class="text-xs text-gray-600 mt-1">Đã chọn: @SelectedFileName</p>
                    }
                </div>
                <button type="submit"
                        class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium"
                        disabled="@(IsUploading || SelectedFile == null)">
                    @if (IsUploading)
                    {
                        <span>Đang upload...</span>
                    }
                    else
                    {
                        <span><i class="bi bi-upload mr-1"></i>Upload Subtitle</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-600">@ErrorMessage</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-600">@SuccessMessage</p>
        </div>
    }
</div>

<!-- Transcribe Language Selection Modal -->
@if (ShowTranscribeDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" @onclick="CloseTranscribeModal">
        <div class="bg-white rounded-xl max-w-md w-full" @onclick:stopPropagation="true">
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h5 class="text-lg font-semibold text-gray-900">Chọn ngôn ngữ</h5>
                <button type="button" class="text-gray-400 hover:text-gray-600" @onclick="CloseTranscribeModal">
                    <i class="bi bi-x-lg text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <!-- Search Input -->
                <div class="mb-4">
                    <div class="relative">
                        <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text"
                               @bind="LanguageSearchTerm"
                               @bind:event="oninput"
                               @onfocus="() => ShowLanguageDropdown = true"
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               placeholder="Tìm kiếm ngôn ngữ..."/>
                    </div>
                </div>

                <!-- Language Dropdown -->
                <div class="relative">
                    <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
                        @if (FilteredLanguages.Any())
                        {
                            @foreach (var lang in FilteredLanguages)
                            {
                                <button type="button"
                                        class="w-full px-4 py-3 text-left border-b border-gray-100 last:border-b-0 hover:bg-gray-50 transition-colors @(SelectedLanguage == lang.Code ? "bg-primary-50 border-primary-200" : "")"
                                        @onclick="() => SelectLanguage(lang.Code)"
                                        @onkeydown="@(e => HandleKeyDown(e, lang))">
                                    <div class="font-medium text-gray-900">@lang.Name</div>
                                    <div class="text-sm text-gray-600">@lang.NativeName</div>
                                </button>
                            }
                        }
                        else
                        {
                            <div class="px-4 py-3 text-center text-gray-500 text-sm">
                                Không tìm thấy ngôn ngữ
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-gray-200 flex justify-end gap-2">
                <button type="button"
                        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                        @onclick="CloseTranscribeModal">
                    Hủy
                </button>
                <button type="button"
                        class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                        @onclick="HandleTranscribe"
                        disabled="@(IsTranscribing || string.IsNullOrEmpty(SelectedLanguage))">
                    @if (IsTranscribing)
                    {
                        <span>Đang xử lý...</span>
                    }
                    else
                    {
                        <span>OK</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public Guid VideoId { get; set; }
    [Parameter] public bool CanPlay { get; set; }
    [Parameter] public EventCallback OnSubtitleChanged { get; set; }

    [Inject] public IVideoSubtitleApi VideoSubtitleApi { get; set; } = null!;
    [Inject] public ISubtitleTranscribeApi SubtitleTranscribeApi { get; set; } = null!;
    [Inject] public IJSRuntime JSRuntime { get; set; } = null!;

    private List<VideoSubtitleDto>? Subtitles { get; set; }
    private UploadSubtitleModel UploadModel { get; set; } = new();
    private IBrowserFile? SelectedFile { get; set; }
    private string? SelectedFileName { get; set; }
    private bool IsUploading { get; set; }
    private bool IsDeleting { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    private bool ShowTranscribeDialog { get; set; }
    private string SelectedLanguage { get; set; } = string.Empty;
    private bool IsTranscribing { get; set; }
    private string LanguageSearchTerm { get; set; } = string.Empty;
    private bool ShowLanguageDropdown { get; set; } = true;

    private List<LanguageHelper.LanguageInfo> AllLanguages { get; set; } = new();

    private List<LanguageHelper.LanguageInfo> FilteredLanguages
    {
        get
        {
            if (string.IsNullOrWhiteSpace(LanguageSearchTerm))
                return AllLanguages;

            var searchLower = LanguageSearchTerm.ToLowerInvariant();
            return AllLanguages.Where(lang =>
                lang.Name.ToLowerInvariant().Contains(searchLower) ||
                lang.NativeName.ToLowerInvariant().Contains(searchLower) ||
                lang.Code.ToLowerInvariant().Contains(searchLower)
            ).ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        AllLanguages = LanguageHelper.GetSupportedLanguages();
        await LoadSubtitles();
    }

    private void SelectLanguage(string code)
    {
        SelectedLanguage = code;
        ShowLanguageDropdown = false;
        LanguageSearchTerm = string.Empty;
    }

    private void HandleKeyDown(KeyboardEventArgs e, LanguageHelper.LanguageInfo lang)
    {
        if (e.Key == "Enter" || e.Key == " ")
        {
            SelectLanguage(lang.Code);
        }
    }

    private async Task LoadSubtitles()
    {
        try
        {
            Subtitles = await VideoSubtitleApi.GetSubtitles(VideoId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi tải danh sách subtitle: {ex.Message}";
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        var extension = Path.GetExtension(file.Name).ToLowerInvariant();
        if (extension != ".vtt")
        {
            ErrorMessage = "Chỉ chấp nhận file .vtt";
            SelectedFile = null;
            SelectedFileName = null;
            return;
        }

        SelectedFile = file;
        SelectedFileName = file.Name;
        UploadModel.File = file;
        ErrorMessage = null;
    }

    private async Task HandleUpload()
    {
        if (SelectedFile == null || string.IsNullOrWhiteSpace(UploadModel.Language))
        {
            ErrorMessage = "Vui lòng chọn file và nhập tên ngôn ngữ";
            return;
        }

        IsUploading = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await using var stream = SelectedFile.OpenReadStream(5 * 1024 * 1024); // 5MB
            var streamPart = new StreamPart(stream, SelectedFile.Name, SelectedFile.ContentType);

            await VideoSubtitleApi.UploadSubtitle(VideoId, UploadModel.Language, streamPart);

            SuccessMessage = "Upload subtitle thành công!";
            UploadModel = new UploadSubtitleModel();
            SelectedFile = null;
            SelectedFileName = null;

            await LoadSubtitles();
            await OnSubtitleChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi upload subtitle: {ex.Message}";
        }
        finally
        {
            IsUploading = false;
        }
    }

    private async Task DeleteSubtitle(Guid subtitleId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa subtitle này?"))
            return;

        IsDeleting = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await VideoSubtitleApi.DeleteSubtitle(subtitleId);
            SuccessMessage = "Xóa subtitle thành công!";
            await LoadSubtitles();
            await OnSubtitleChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi xóa subtitle: {ex.Message}";
        }
        finally
        {
            IsDeleting = false;
        }
    }

    private void ShowTranscribeModal()
    {
        ShowTranscribeDialog = true;
        SelectedLanguage = "auto";
        LanguageSearchTerm = string.Empty;
        ShowLanguageDropdown = true;
        ErrorMessage = null;
        SuccessMessage = null;
    }

    private void CloseTranscribeModal()
    {
        ShowTranscribeDialog = false;
        SelectedLanguage = string.Empty;
        LanguageSearchTerm = string.Empty;
        ShowLanguageDropdown = false;
    }

    private async Task HandleTranscribe()
    {
        if (string.IsNullOrEmpty(SelectedLanguage))
        {
            ErrorMessage = "Vui lòng chọn ngôn ngữ";
            return;
        }

        IsTranscribing = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await SubtitleTranscribeApi.CreateTranscribeRequest(VideoId, new ISubtitleTranscribeApi.CreateTranscribeRequestDto
            {
                Language = SelectedLanguage
            });

            SuccessMessage = "Đã gửi yêu cầu transcribe. Vui lòng chờ xử lý...";
            CloseTranscribeModal();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi tạo yêu cầu transcribe: {ex.Message}";
        }
        finally
        {
            IsTranscribing = false;
        }
    }

    private class UploadSubtitleModel
    {
        public string Language { get; set; } = string.Empty;
        public IBrowserFile? File { get; set; }
    }

}