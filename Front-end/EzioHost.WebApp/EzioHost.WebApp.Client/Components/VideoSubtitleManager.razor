@using EzioHost.Shared.Models
@using EzioHost.WebApp.Client.Services
@using Microsoft.AspNetCore.Components.Forms
@using Refit

<div class="space-y-4">
    <div class="flex justify-between items-center">
        <h6 class="text-sm font-semibold text-gray-900">Quản lý Subtitle</h6>
    </div>

    <!-- Subtitle List -->
    <div class="space-y-2 max-h-48 overflow-y-auto">
        @if (Subtitles != null && Subtitles.Any())
        {
            @foreach (var subtitle in Subtitles)
            {
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <span class="text-sm font-medium text-gray-900">@subtitle.Language</span>
                        <span class="text-xs text-gray-500 ml-2">@subtitle.FileName</span>
                    </div>
                    <button type="button" 
                            class="px-2 py-1 text-red-600 hover:bg-red-50 rounded transition-colors text-sm"
                            @onclick="() => DeleteSubtitle(subtitle.Id)"
                            disabled="@IsDeleting">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            }
        }
        else
        {
            <p class="text-sm text-gray-500 text-center py-2">Chưa có subtitle nào</p>
        }
    </div>

    <!-- Upload Form -->
    <div class="border-t border-gray-200 pt-4">
        <h6 class="text-sm font-semibold text-gray-900 mb-3">Thêm Subtitle mới</h6>
        <EditForm Model="@UploadModel" OnValidSubmit="HandleUpload">
            <DataAnnotationsValidator />
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ngôn ngữ</label>
                    <InputText @bind-Value="UploadModel.Language" 
                               class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                               placeholder="Ví dụ: Vietnamese, English"/>
                    <ValidationMessage For="@(() => UploadModel.Language)" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">File Subtitle (.vtt)</label>
                    <InputFile OnChange="HandleFileSelected" 
                               accept=".vtt"
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"/>
                    <ValidationMessage For="@(() => UploadModel.File)" />
                    @if (SelectedFileName != null)
                    {
                        <p class="text-xs text-gray-600 mt-1">Đã chọn: @SelectedFileName</p>
                    }
                </div>
                <button type="submit" 
                        class="w-full px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors text-sm font-medium"
                        disabled="@(IsUploading || SelectedFile == null)">
                    @if (IsUploading)
                    {
                        <span>Đang upload...</span>
                    }
                    else
                    {
                        <span><i class="bi bi-upload mr-1"></i>Upload Subtitle</span>
                    }
                </button>
            </div>
        </EditForm>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-600">@ErrorMessage</p>
        </div>
    }

    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-sm text-green-600">@SuccessMessage</p>
        </div>
    }
</div>

@code {
    [Parameter] public Guid VideoId { get; set; }
    [Parameter] public EventCallback OnSubtitleChanged { get; set; }

    [Inject] public IVideoSubtitleApi VideoSubtitleApi { get; set; } = null!;
    [Inject] public IJSRuntime JSRuntime { get; set; } = null!;

    private List<VideoSubtitleDto>? Subtitles { get; set; }
    private UploadSubtitleModel UploadModel { get; set; } = new();
    private IBrowserFile? SelectedFile { get; set; }
    private string? SelectedFileName { get; set; }
    private bool IsUploading { get; set; }
    private bool IsDeleting { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadSubtitles();
    }

    private async Task LoadSubtitles()
    {
        try
        {
            Subtitles = await VideoSubtitleApi.GetSubtitles(VideoId);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi tải danh sách subtitle: {ex.Message}";
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;

        var extension = Path.GetExtension(file.Name).ToLowerInvariant();
        if (extension != ".vtt")
        {
            ErrorMessage = "Chỉ chấp nhận file .vtt";
            SelectedFile = null;
            SelectedFileName = null;
            return;
        }

        SelectedFile = file;
        SelectedFileName = file.Name;
        UploadModel.File = file;
        ErrorMessage = null;
    }

    private async Task HandleUpload()
    {
        if (SelectedFile == null || string.IsNullOrWhiteSpace(UploadModel.Language))
        {
            ErrorMessage = "Vui lòng chọn file và nhập tên ngôn ngữ";
            return;
        }

        IsUploading = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await using var stream = SelectedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024); // 5MB
            var streamPart = new StreamPart(stream, SelectedFile.Name, SelectedFile.ContentType);

            await VideoSubtitleApi.UploadSubtitle(VideoId, UploadModel.Language, streamPart);
            
            SuccessMessage = "Upload subtitle thành công!";
            UploadModel = new UploadSubtitleModel();
            SelectedFile = null;
            SelectedFileName = null;

            await LoadSubtitles();
            await OnSubtitleChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi upload subtitle: {ex.Message}";
        }
        finally
        {
            IsUploading = false;
        }
    }

    private async Task DeleteSubtitle(Guid subtitleId)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa subtitle này?"))
            return;

        IsDeleting = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            await VideoSubtitleApi.DeleteSubtitle(subtitleId);
            SuccessMessage = "Xóa subtitle thành công!";
            await LoadSubtitles();
            await OnSubtitleChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Lỗi khi xóa subtitle: {ex.Message}";
        }
        finally
        {
            IsDeleting = false;
        }
    }

    private class UploadSubtitleModel
    {
        public string Language { get; set; } = string.Empty;
        public IBrowserFile? File { get; set; }
    }
}
