@page "/upload-video"
@inject IJSRuntime JsRuntime

<PageTitle>Upload Video - EzioHost</PageTitle>

<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 fw-bold mb-2">
                <i class="bi bi-cloud-upload me-2"></i>
                Upload Video
            </h1>
            <p class="text-muted">Tải lên video của bạn và sử dụng AI để upscale chất lượng</p>
        </div>
    </div>

    <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- Drag & Drop Zone -->
                    <div class="upload-zone @(IsDragOver ? "drag-over" : "")" 
                         @ondragover="OnDragOver" 
                         @ondragleave="OnDragLeave" 
                         @ondrop="OnDrop"
                         @onclick="TriggerFileInput">
                        
                        <input type="file" 
                               id="fileInput" 
                               @ref="_fileInput" 
                               @onchange="OnFileSelected" 
                               accept="video/*" 
                               multiple 
                               style="display: none;" />
                        
                        @if (SelectedFiles.Any())
                        {
                            <div class="uploaded-files">
                                <h5 class="mb-3">Files đã chọn:</h5>
                                @foreach (var file in SelectedFiles)
                                {
                                    <div class="file-item d-flex align-items-center justify-content-between p-3 bg-light rounded mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-file-earmark-play text-primary me-3" style="font-size: 1.5rem;"></i>
                                            <div>
                                                <div class="fw-bold">@file.Name</div>
                                                <small class="text-muted">@FormatFileSize(file.Size)</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveFile(file)">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="upload-placeholder text-center py-5">
                                <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
                                <h4 class="mb-3">Kéo thả video vào đây</h4>
                                <p class="text-muted mb-4">Hoặc click để chọn file</p>
                                <button class="btn btn-primary btn-lg">
                                    <i class="bi bi-folder2-open me-2"></i>Chọn Video
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Upload Progress -->
                    @if (IsUploading)
                    {
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold">Đang upload...</span>
                                <span class="text-muted">@UploadProgress%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: @UploadProgress%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Video Settings -->
            @if (SelectedFiles.Any())
            {
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-gear me-2"></i>Cài đặt Video
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Tiêu đề</label>
                                <input type="text" class="form-control" @bind="VideoTitle" placeholder="Nhập tiêu đề video" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Chất lượng mục tiêu</label>
                                <select class="form-select" @bind="TargetQuality">
                                    <option value="1080p">1080p (Full HD)</option>
                                    <option value="720p">720p (HD)</option>
                                    <option value="480p">480p (SD)</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Mô tả</label>
                                <textarea class="form-control" rows="3" @bind="VideoDescription" placeholder="Mô tả video (tùy chọn)"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">AI Upscale</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="EnableAiUpscale" id="aiUpscale" />
                                    <label class="form-check-label" for="aiUpscale">
                                        Sử dụng AI để upscale video
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Model AI</label>
                                <select class="form-select" @bind="SelectedAiModel" disabled="@(!EnableAiUpscale)">
                                    <option value="realesr-animevideov3">Real-ESRGAN Anime Video v3</option>
                                    <option value="realesr-general">Real-ESRGAN General</option>
                                    <option value="waifu2x">Waifu2x</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Upload Guidelines -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Hướng dẫn Upload
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>Định dạng hỗ trợ:</strong> MP4, AVI, MOV, MKV
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>Kích thước tối đa:</strong> 2GB mỗi file
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>Chất lượng:</strong> Không quá 4K
                        </li>
                        <li class="mb-0">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>AI Upscale:</strong> Hiện tại chỉ tối ưu cho anime
                        </li>
                    </ul>
                </div>
            </div>

            <!-- AI Features -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-cpu me-2"></i>Tính năng AI
                    </h6>
                </div>
                <div class="card-body">
                    <div class="feature-item mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-magic text-primary me-2"></i>
                            <strong>AI Upscale</strong>
                        </div>
                        <small class="text-muted">Sử dụng ONNX Runtime để upscale video với AI</small>
                    </div>
                    <div class="feature-item mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-image text-primary me-2"></i>
                            <strong>Tối ưu Anime</strong>
                        </div>
                        <small class="text-muted">Đặc biệt tối ưu cho nội dung anime</small>
                    </div>
                    <div class="feature-item">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-lightning text-primary me-2"></i>
                            <strong>Xử lý nhanh</strong>
                        </div>
                        <small class="text-muted">GPU acceleration cho tốc độ xử lý cao</small>
                    </div>
                </div>
            </div>

            <!-- Upload Actions -->
            @if (SelectedFiles.Any())
            {
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="mb-3">Hành động</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" @onclick="StartUpload" disabled="@IsUploading">
                                @if (IsUploading)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Đang upload...</span>
                                }
                                else
                                {
                                    <i class="bi bi-cloud-upload me-2"></i>
                                    <span>Bắt đầu Upload</span>
                                }
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="ClearFiles" disabled="@IsUploading">
                                <i class="bi bi-x-circle me-2"></i>Xóa tất cả
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 0.5rem;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        min-height: 300px;
    }
    
    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    
    .upload-placeholder {
        pointer-events: none;
    }
    
    .file-item {
        transition: all 0.3s ease;
    }
    
    .file-item:hover {
        background: #e9ecef !important;
    }
    
    .feature-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .feature-item:last-child {
        border-bottom: none;
    }
</style>

@code {
    private ElementReference _fileInput;
    private List<IBrowserFile> SelectedFiles { get; set; } = new();
    private bool IsDragOver { get; set; } = false;
    private bool IsUploading { get; set; } = false;
    private int UploadProgress { get; set; } = 0;
    
    // Video settings
    private string VideoTitle { get; set; } = "";
    private string VideoDescription { get; set; } = "";
    private string TargetQuality { get; set; } = "1080p";
    private bool EnableAiUpscale { get; set; } = true;
    private string SelectedAiModel { get; set; } = "realesr-animevideov3";

    private async Task TriggerFileInput()
    {
        await JsRuntime.InvokeVoidAsync("clickFileInput", _fileInput);
    }

    private async Task OnFileSelected(ChangeEventArgs e)
    {
        var files = await JsRuntime.InvokeAsync<IBrowserFile[]>("getSelectedFiles", _fileInput);
        if (files != null)
        {
            SelectedFiles.AddRange(files);
            if (SelectedFiles.Count == 1 && string.IsNullOrEmpty(VideoTitle))
            {
                VideoTitle = Path.GetFileNameWithoutExtension(SelectedFiles[0].Name);
            }
            StateHasChanged();
        }
    }

    private void OnDragOver(DragEventArgs e)
    {
        IsDragOver = true;
    }

    private void OnDragLeave(DragEventArgs e)
    {
        IsDragOver = false;
    }

    private async Task OnDrop(DragEventArgs e)
    {
        IsDragOver = false;
        
        var files = await JsRuntime.InvokeAsync<IBrowserFile[]>("getDroppedFiles", e);
        if (files != null)
        {
            SelectedFiles.AddRange(files);
            if (SelectedFiles.Count == 1 && string.IsNullOrEmpty(VideoTitle))
            {
                VideoTitle = Path.GetFileNameWithoutExtension(SelectedFiles[0].Name);
            }
            StateHasChanged();
        }
    }

    private void RemoveFile(IBrowserFile file)
    {
        SelectedFiles.Remove(file);
        StateHasChanged();
    }

    private async Task StartUpload()
    {
        if (!SelectedFiles.Any())
        {
            await JsRuntime.InvokeVoidAsync("showToast", "warning", "Vui lòng chọn ít nhất một file");
            return;
        }

        IsUploading = true;
        UploadProgress = 0;
        StateHasChanged();

        // Simulate upload progress
        for (int i = 0; i <= 100; i += 10)
        {
            UploadProgress = i;
            StateHasChanged();
            await Task.Delay(200);
        }

        IsUploading = false;
        await JsRuntime.InvokeVoidAsync("showToast", "success", "Upload thành công!");
        
        // Clear files after successful upload
        ClearFiles();
    }

    private void ClearFiles()
    {
        SelectedFiles.Clear();
        VideoTitle = "";
        VideoDescription = "";
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = ["B", "KB", "MB", "GB"];
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len /= 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
}
